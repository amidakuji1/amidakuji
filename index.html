<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>あみだくじジェネレーター</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    canvas { width: 100%; height: 400px; border: 1px solid #ddd; }
    .fade-in { animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">
  <div id="admin" class="w-full max-w-xl bg-white shadow-lg rounded-2xl p-6 fade-in">
    <h1 class="text-2xl font-bold mb-4 text-center">あみだくじ設定</h1>
    <label class="block font-semibold mb-1">参加者（1行ずつ）</label>
    <textarea id="players" class="w-full border rounded p-2 mb-4" rows="3">小泉\n久郷\n吉田</textarea>

    <label class="block font-semibold mb-1">結果（1行ずつ）</label>
    <textarea id="results" class="w-full border rounded p-2 mb-4" rows="3">27\n29\n休み</textarea>

    <label class="block font-semibold mb-1">固定設定（例: 小泉,休み）</label>
    <textarea id="fixed" class="w-full border rounded p-2 mb-4" rows="2">小泉,休み</textarea>

    <button id="generate" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded">URLを生成</button>
    <div id="urlArea" class="mt-4 hidden">
      <p class="font-semibold mb-1">共有用URL:</p>
      <input id="shareUrl" readonly class="w-full border rounded p-2 text-sm" />
    </div>
  </div>

  <div id="play" class="hidden w-full max-w-3xl bg-white shadow-lg rounded-2xl p-6 mt-4 fade-in">
    <h2 class="text-xl font-bold mb-2 text-center">あみだくじ</h2>
    <canvas id="amidakuji"></canvas>
    <div id="playerButtons" class="flex justify-center space-x-2 mt-4"></div>
    <div id="resultDisplay" class="text-center mt-4 text-lg font-semibold"></div>
  </div>

  <script>
    const adminDiv = document.getElementById('admin');
    const playDiv = document.getElementById('play');
    const canvas = document.getElementById('amidakuji');
    const ctx = canvas.getContext('2d');

    function initAdminMode() {
      adminDiv.classList.remove('hidden');
      playDiv.classList.add('hidden');

      document.getElementById('generate').onclick = () => {
        const players = document.getElementById('players').value.trim().split(/\n|,/).map(v => v.trim()).filter(v => v);
        const results = document.getElementById('results').value.trim().split(/\n|,/).map(v => v.trim()).filter(v => v);
        const fixedPairs = document.getElementById('fixed').value.trim().split(/\n|,/).map(v => v.trim()).filter(v => v);
        const fixed = {};
        for (let i = 0; i < fixedPairs.length; i += 2) {
          if (fixedPairs[i] && fixedPairs[i+1]) fixed[fixedPairs[i]] = fixedPairs[i+1];
        }
        const config = { players, results, fixed };
        const encoded = encodeURIComponent(btoa(JSON.stringify(config)));
        const url = `${location.origin}${location.pathname}#data=${encoded}`;
        document.getElementById('shareUrl').value = url;
        document.getElementById('urlArea').classList.remove('hidden');
      };
    }

    function startAmidakuji(config) {
      adminDiv.classList.add('hidden');
      playDiv.classList.remove('hidden');

      const { players, results, fixed } = config;
      const columns = players.length;
      canvas.width = canvas.clientWidth;
      canvas.height = 400;

      const spacingX = canvas.width / (columns + 1);
      const spacingY = canvas.height / 15;
      const lines = [];

      for (let i = 0; i < columns; i++) {
        lines.push([]);
      }

      for (let y = 1; y < 14; y++) {
        if (Math.random() < 0.5) {
          const pos = Math.floor(Math.random() * (columns - 1));
          lines[pos].push(y);
        }
      }

      ctx.lineWidth = 2;
      ctx.strokeStyle = '#333';

      function drawLines() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < columns; i++) {
          ctx.beginPath();
          ctx.moveTo(spacingX * (i + 1), spacingY);
          ctx.lineTo(spacingX * (i + 1), spacingY * 14);
          ctx.stroke();
        }
        for (let i = 0; i < lines.length; i++) {
          for (const y of lines[i]) {
            ctx.beginPath();
            ctx.moveTo(spacingX * (i + 1), spacingY * y);
            ctx.lineTo(spacingX * (i + 2), spacingY * y);
            ctx.stroke();
          }
        }
      }

      drawLines();

      const mapping = {};
      const shuffled = [...results];
      for (const name in fixed) {
        mapping[name] = fixed[name];
        const idx = shuffled.indexOf(fixed[name]);
        if (idx !== -1) shuffled.splice(idx, 1);
      }

      const remainingPlayers = players.filter(p => !fixed[p]);
      for (const p of remainingPlayers) {
        mapping[p] = shuffled.pop();
      }

      const btnContainer = document.getElementById('playerButtons');
      btnContainer.innerHTML = '';
      const resultDisplay = document.getElementById('resultDisplay');

      players.forEach(name => {
        const btn = document.createElement('button');
        btn.textContent = name;
        btn.className = 'bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded';
        btn.onclick = () => animatePath(name);
        btnContainer.appendChild(btn);
      });

      function animatePath(name) {
        drawLines();
        const col = players.indexOf(name);
        let x = spacingX * (col + 1);
        let y = spacingY;
        const path = [[x, y]];

        for (let i = 1; i <= 14; i++) {
          y = spacingY * i;
          if (lines[col].includes(i)) {
            x += spacingX;
            col++;
          } else if (col > 0 && lines[col - 1].includes(i)) {
            x -= spacingX;
            col--;
          }
          path.push([x, y]);
        }

        let i = 0;
        function step() {
          if (i >= path.length - 1) {
            resultDisplay.textContent = `${name} の結果：${mapping[name]}`;
            return;
          }
          ctx.beginPath();
          ctx.moveTo(path[i][0], path[i][1]);
          ctx.lineTo(path[i + 1][0], path[i + 1][1]);
          ctx.strokeStyle = 'red';
          ctx.stroke();
          i++;
          setTimeout(step, 100);
        }
        step();
      }
    }

    const hash = location.hash;
    if (hash && hash.startsWith('#data=')) {
      const encoded = hash.replace('#data=', '');
      const decoded = atob(decodeURIComponent(encoded));
      const config = JSON.parse(decoded);
      startAmidakuji(config);
    } else {
      initAdminMode();
    }
  </script>
</body>
</html>
